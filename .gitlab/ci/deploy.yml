build-snap:
  stage: build
  image: ubuntudesktop/gnome-3-38-2004
  before_script:
    - echo $SNAPCRAFT_LOGIN_FILE | base64 --decode --ignore-garbage > snapcraft.login
    - snapcraft login --with snapcraft.login
    - apt update
    - apt install cargo gettext-base cmake -y
  script:
    - make snap
    - snapcraft upload --release=stable squiid*.snap

build-appimage:
  stage: build
  image: archlinux:latest
  before_script:
    - pacman --noconfirm -Syu curl make rust cmake
    - curl -L https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -o /usr/local/bin/appimagetool
    - chmod a+rx /usr/local/bin/appimagetool
    - previous_dir=`pwd`
    - cd /opt; appimagetool --appimage-extract
    - cd $previous_dir
    - mv /opt/squashfs-root /opt/appimagetool.AppDir
    - rm /usr/local/bin/appimagetool
    - ln -s /opt/appimagetool.AppDir/AppRun /usr/local/bin/appimagetool

  script:
    - make appimage
    - mv package-build/Squiid_Calculator.AppImage Squiid_Calculator.AppImage
  artifacts:
    paths:
      - Squiid_Calculator.AppImage

build-musl:
  stage: build
  image: clux/muslrust:stable
  script:
    - make build
    - mv target/x86_64-unknown-linux-musl/release/squiid squiid
  artifacts:
    paths:
      - squiid

build-windows:
  stage: build
  image: alpine:latest
  before_script:
    - apk update
    - apk add curl make cmake gcc mingw-w64-gcc musl-dev gettext
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -t x86_64-pc-windows-gnu -y
  script:
    - source "$HOME/.cargo/env"
    - make windows-build
    - cp target/x86_64-pc-windows-gnu/release/squiid.exe squiid.exe
    - make windows-installer skip_build=1
  artifacts:
    paths:
      - ./squiid.exe
      - package-build/

build-windows-installer:
  stage: build
  needs:
    - job: build-windows
      artifacts: true
  image:
    name: amake/innosetup
    entrypoint: [""]
  script:
    - cp -r --no-preserve=mode,ownership package-build/ new-package-build/
    - cd new-package-build/
    - iscc squiid.iss
    - mv Output/squiid-installer.exe ../
    - cd ..
  artifacts:
    paths:
      - squiid-installer.exe


# build-deb:
#   stage: build
#   image: ubuntu:focal
#   before_script:
#     - DEBIAN_FRONTEND=noninteractive apt update
#     - DEBIAN_FRONTEND=noninteractive apt install -y build-essential binutils lintian debhelper dh-make devscripts cmake fakeroot git cargo cmake gnupg
#     - echo "$GPG_PRIVATE_KEY_B64" | base64 --decode | gpg --batch --import
#     - gpg --list-keys --fingerprint --with-colons | sed -E -n -e 's/^fpr:::::::::([0-9A-F]+):$/\1:6:/p' | gpg --import-ownertrust
#   script:
#     - make deb DEBUILD_OPTIONS="-p\"gpg --batch --passphrase $GPG_PASSPHRASE --pinentry-mode loopback\""
#   artifacts:
#     paths:
#       - package-build/squiid_0.1.0-1_amd64.deb
#       - package-build/squiid_0.1.0-1_amd64.dsc
#       - package-build/squiid_0.1.0-1_amd64.changes

# build-deb:
#   stage: build
#   image: proget.makedeb.org/docker/makedeb/makedeb:debian-bullseye
#   before_script:
#     # copy needed files
#     - mkdir package-build/
#     - cp packages/debian/PKGBUILD package-build/

#     # add non root user to execute makedeb
#     - useradd -m non_root
#     - "echo 'non_root ALL=NOPASSWD: ALL' >> /etc/sudoers"
#     - chown -R non_root:non_root package-build/

#     # install build dependencies
#     - cat /etc/apt/sources.list.d/makedeb.list
#     - apt install -y curl cmake git rustup
#     # - curl --proto '=https' --tlsv1.3 https://sh.rustup.rs -sSf | sh -s -- -y
#     # - source "$HOME/.cargo/env"
#     # - rustup target add x86_64-unknown-linux-musl
#     # - rustup show
#     # - rustup default stable

#   script:
#     - git archive --format=tar.gz -o package-build/squiid-0.1.0.tar.gz trunk
#     - cd package-build/
#     - sudo -u non_root makedeb
